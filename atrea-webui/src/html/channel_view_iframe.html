<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="style.css">
    <style>
      #cvi_top {
        display: flex;
        flex-wrap: wrap;
      }
      #cvi_img {
        width: 230px;
        height: 230px;
        margin-right: 10px;
      }
      #cvi_top th { text-align: right; }
      #cvi_top td { text-align: left; }
      /*
      #cvi_raids th { border-bottom: var(--border); }
      #cvi_raids td { border-bottom: var(--border); }
      #cvi_raids th:not(:last-child) { border-right: var(--border); }
      */
      #cvi_raids tr:nth-child(even) { background-color: var(--nav-bg); }
      #cvi_raids td:not(:first-child) { text-align: center; }
    </style>
    <script type="module">
      import {r,g,t} from "./xeact.js";
      const n=(e)=>document.createElement(e);
      const fill_raid_table=(table,data,ir)=>{
        data.forEach((co)=>{
          var tr=n("tr");
          var td=n("td");td.innerText=(ir?co["raider"]:co["target"]);tr.appendChild(td);
          td=n("td");td.innerText=co["raid_count"];tr.appendChild(td);
          td=n("td");td.innerText=co["total_viewers"];tr.appendChild(td);
          td=n("td");td.innerText=co["average_raid_size"];tr.appendChild(td);
          table.appendChild(tr);
        });
      };

      r(()=>{
        var params = new URLSearchParams(window.location.search);
        var channel = params.get("channel");
        fetch("api/channel/"+channel+"/twitch_info")
          .then(response=>response.json())
          .then(res=>{
            g("cvi_img").src=res["profile_image_url"];
            g("cvi_title").innerText=res["display_name"];
            g("cvi_twitch_link").href="https://twitch.tv/"+res["login"];
            g("cvi_desc").innerText=res["description"];
            g("cvi_id").innerText=res["id"];
            var created_date = new Date(res["created_at"] * 1_000);
            g("cvi_created").innerText=created_date.toISOString().replace('T', ' ').slice(0, -5);
            g("cvi_b_type").innerText=res["broadcaster_type"];
          })
          .catch(error=>console.error('Error:',error));

        fetch("api/raids/to/"+channel+"/stats")
          .then(response=>response.json())
          .then(incomming_raiders=>fill_raid_table(g("cvi_raids_i"),incomming_raiders,true))
          .catch(error=>console.error('Error:',error));
        fetch("api/raids/from/"+channel+"/stats")
          .then(response=>response.json())
          .then(incomming_raiders=>fill_raid_table(g("cvi_raids_o"),incomming_raiders,false))
          .catch(error=>console.error('Error:',error));
      });
    </script>
  </head>
  <body>
    <div id="cvi_top">
      <img id="cvi_img" src="loading_image.svg" />
      <div>
        <h1><span id="cvi_title">Loading..</span> <a id="cvi_twitch_link"><img src="twitch_glitch_logo.svg" width="23px"></a></h1>
        <table>
          <tr><th>Twitch ID</th><td id="cvi_id"></td></tr>
          <tr><th>Creation Date</th><td id="cvi_created"></td></tr>
          <tr><th>Broadcaster Type</th><td id="cvi_b_type"></td></tr>
        </table>
        <div id="cvi_desc"></div>
      </div>
    </div>
    <div id="cvi_raids">
    <h3>Incomming Raid Summary</h3>
      <table id="cvi_raids_i">
        <tr><th>Raider</th><th>Raid count</th><th>Total size</th><th>Avg Size</th></tr>
      </table>
      <h3>Outgoing Raid Summary</h3>
      <table id="cvi_raids_o">
        <tr><th>Target</th><th>Raid count</th><th>Total size</th><th>Avg Size</th></tr>
      </table>
    </div>
  </body>
</html>

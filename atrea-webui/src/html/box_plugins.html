<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8"> 
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="box_style.css">
    <style>
      ul {
        list-style-type: none;
        padding: 0;
        display: flex;
        flex-wrap: wrap;
      }

      ul>li {
        display: block;
        padding: 5px;
        margin: 5px;
        flex-wrap: nowrap;
        border-radius: 15px;
        background-color: var(--bg-alt);
        height: fit-content;
      }

      h2 {
        margin-top: 0;
      }
      h2>button::before {
        content: '[';
      }
      h2>button::after {
        content: ']';
      }
    </style>
    <script defer type="module">
      import {g,x} from "./libs/xeact.js";
      import{n,cr,ce}from"./atrea.js";

      const toggle_plugin=e=>{
        let plugin_name=e.target.getAttribute("data-name");
        e.target.classList.add("gone");
        fetch("api/plugins/"+(e.target.innerText.trim())+"/"+plugin_name)
          .then(cr)
          .then(a=>{
            if(a.ok){
              e.target.innerText=(e.target.innerText.trim()=="enable"?"disable":"enable");
              e.target.classList.remove("gone");
            }
          })
          .catch(ce);
      };

      const setting_set_button_click=(event)=>{
        let new_value=g(event.target.getAttribute("data-pfid")).value;
        let plugin_name=event.target.getAttribute("data-plugin");
        let setting_key=event.target.getAttribute("data-skey");
        fetch("api/plugins/update_setting/"+encodeURIComponent(plugin_name)+"/"+encodeURIComponent(setting_key)+"/"+encodeURIComponent(new_value))
          .then(cr)
          .catch(ce);
      };

      const add_plugin=data=>{
        var li=n("li");
        var h2=n("h2");
        h2.innerText=data["plugin_name"].replaceAll("_", " ");
        var btn=n("button");
        btn.innerText=(data["enabled"]?"disable":"enable");
        btn.setAttribute("data-name", data["plugin_name"]);
        btn.onclick=toggle_plugin;
        h2.appendChild(btn);
        li.appendChild(h2);
        var p_node=n("p");
        p_node.innerText=data["description"];
        li.appendChild(p_node);
        if(Object.keys(data["settings"]).length!==0){
          var h3=n("h3");h3.innerText="Settings";li.appendChild(h3);
          for(const setting_key in data["settings"]) {
            var sdiv=n("div");
            var slabel=n("label");
            var pfid="plugin-_-"+data["plugin_name"]+"-_-"+setting_key;
            slabel.setAttribute("for",pfid);
            slabel.innerText=setting_key;
            sdiv.appendChild(slabel);
            var sinput=n("input");
            sinput.setAttribute("id",pfid);
            sinput.setAttribute("value",data["settings"][setting_key]);
            sinput.setAttribute("type","text");
            sdiv.appendChild(sinput);
            var sbtn=n("button");
            sbtn.setAttribute("data-pfid",pfid);
            sbtn.setAttribute("data-plugin",data["plugin_name"]);
            sbtn.setAttribute("data-skey",setting_key);
            sbtn.onclick=setting_set_button_click;
            sbtn.innerText="apply";
            sdiv.appendChild(sbtn);
            li.appendChild(sdiv);
          }
        }
        g("plugin_list").appendChild(li);
      };

      const gen_plugin_list=()=>{
        fetch("api/plugins/list")
          .then(cr)
          .then(response=>response.json())
          .then((res)=>{
            res.forEach((data)=>{
              add_plugin(data);
            });
          })
          .catch(ce);
      };
      gen_plugin_list()

      g("refresh_db").onclick=e=>{
        e.target.classList.add("gone");
        x(g("plugin_list"));
        fetch("api/plugins/update_db")
          .then(cr)
          .then(a=>{
            if(a.ok){
              gen_plugin_list();
              e.target.classList.remove("gone");
            }
          })
          .catch(ce);
      };
    </script>
    <!--HEAD-->
  </head>
  <body>
    <p><b>NOTE:</b> Many changes won't be visible until you reload the window.</p>
    <button id="refresh_db">Check filesystem for changes</button>
    <ul id="plugin_list"></ul>
  </body>
</html>
